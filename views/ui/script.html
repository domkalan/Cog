{% extends "ui/frame.html" %}

{% block content %}
<div class="content">
    <div class="container">
        <div class="float-end">
            <a class="btn btn-warning disabled" href="#" id="create-button">Update</a>
            <a class="btn btn-danger" href="#" id="delete-button">Delete</a>
        </div>
        
        <h3>Script: <small>{{ script.title }}</small></h3>
        <div>id: {{ script.id }} - runtime: {{ script.runtime }}</div>
        <hr/>
        <div id="editor" style="width: 100%; height: 600px; border: 1px solid grey; margin-bottom: 16px;">{{ script.code }}</div>
    </div>
</div>
{% endblock %}

{% block script %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.29.1/min/vs/loader.min.js"></script>
<script>
    // Bind to our save button
    const saveButton = document.getElementById("create-button");
    const deleteButton = document.getElementById("delete-button");

    // Import Monaco Editor
    require.config({ paths: { "vs": "https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.29.1/min/vs/" }});

    window.MonacoEnvironment = {
        getWorkerUrl: function(workerId, label) {
            return `data:text/javascript;charset=utf-8,${encodeURIComponent(`
                self.MonacoEnvironment = { baseUrl: "https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.29.1/min/" };
                importScripts("https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.29.1/min/vs/base/worker/workerMain.min.js");`
            )}`;
        }
    };

    require(["vs/editor/editor.main"], function () {
        // Create the editor with some sample JavaScript code
        const editor = monaco.editor.create(document.getElementById("editor"), {
            value: '// :)',
            language: "javascript"
        });

        // Resize the editor when the window size changes
        const editorElement = document.getElementById("editor");
        window.addEventListener("resize", () => editor.layout({
            height: editorElement.offsetHeight
        }));

        window.editor = editor;

            
        fetch('/ui/scripts/{{script.id}}/raw').then(req => req.text()).then((data) => {
            editor.getModel().setValue(data);

            saveButton.classList.remove('disabled');
        })
    });

    saveButton.addEventListener('click', (e) => {
        e.preventDefault();

        if (saveButton.classList.contains('disabled')) {
            return;
        }

        saveButton.classList.add('disabled');

        fetch('/ui/scripts/{{script.id}}', {
            method: 'POST',
            headers: {
                'content-type': 'application/json'
            },
            body: JSON.stringify({
                code: window.editor.getValue()
            })
        }).then(req => req.json()).then((data) => {
            if (!data.id) {
                setTimeout(() => {
                    saveButton.classList.remove('disabled');
                }, 750)
            } else {
                window.location.reload();
            }
        }).catch((error) => {
            alert(error);
        })
    })

    deleteButton.addEventListener('click', (e) => {
        e.preventDefault();

        if (saveButton.classList.contains('disabled')) {
            return;
        }

        if (!confirm('Are you sure you want to delete {{ script.name }}?')) {
            return;
        }

        saveButton.classList.add('disabled');

        fetch('/ui/scripts/{{script.id}}', {
            method: 'DELETE'
        }).then(req => req.json()).then((data) => {
            if (data.id !== null) {
                setTimeout(() => {
                    saveButton.classList.remove('disabled');
                }, 750)
            } else {
                window.location.href = '/ui'
            }
        }).catch((error) => {
            alert(error);
        })
    })
</script>
{% endblock %}